stages:
  - preprocess
  - deploy

preprocess:
  image: python:latest
  stage: preprocess
  script:
    - python --version
    - repo=$(cat $TRIGGER_PAYLOAD | python -mjson.tool | python -c "import sys, json; print(json.load(sys.stdin)['event_data']['repository']['name'])")
    - echo "$repo" >> repo.txt
  artifacts:
    paths:
      - repo.txt

deploy:
  dependencies:
    - preprocess
  image: bitnami/kubectl:latest
  stage: deploy
  only:
    - master
  script:
    - depl="$(cat repo.txt)-deployment.yml"
    - service="$(cat repo.txt)-service.yml"
    - kubectl apply -f k8s/"$service"
    - kubectl apply -f k8s/"$depl"
    - kubectl patch deployment "$(cat repo.txt)" -p '{"spec":{"template":{"metadata":{"labels":{"CI_PIPELINE_ID":"'$CI_PIPELINE_ID'"}}}}}'
