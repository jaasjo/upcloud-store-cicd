stages:
  - build
  - deploy

build:
  stage: build
  script:
    - echo "Hello, $GITLAB_USER_LOGIN, building!"

deploy:
  image: bitnami/kubectl:latest
  stage: deploy
  only:
    - master
  script:
    - kubectl apply -f k8s/simple-go-server.yaml
    - job_id=id_${CI_JOB_ID}
    - export job_id
    - echo "${CI_JOB_ID}"
    - echo "${CI_JOB_STARTED_AT}"
    - kubectl patch deployment simple-go-server -p '{"spec":{"template":{"metadata":{"labels":{"CI_JOB_ID":"$job_id"}}}}}'
